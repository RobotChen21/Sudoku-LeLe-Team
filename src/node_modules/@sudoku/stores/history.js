import { get, writable } from 'svelte/store';
import { userGrid } from './grid';

const MAX_HISTORY = 50;

let undoStack = [];
let redoStack = [];
let lastSnapshot = null;
let restoring = false;

export const historyLength = writable(0);
export const redoLength = writable(0);

function cloneGrid(grid) {
	return grid.map(row => row.slice());
}

function gridsEqual(a, b) {
	if (a === b) return true;
	if (!a || !b) return false;
	if (a.length !== b.length) return false;
	for (let y = 0; y < a.length; y++) {
		if (!a[y] || !b[y] || a[y].length !== b[y].length) return false;
		for (let x = 0; x < a[y].length; x++) {
			if (a[y][x] !== b[y][x]) return false;
		}
	}
	return true;
}

function updateLengths() {
	historyLength.set(undoStack.length);
	redoLength.set(redoStack.length);
}

function setBaseline(grid) {
	lastSnapshot = grid ? cloneGrid(grid) : null;
}

userGrid.subscribe($userGrid => {
	if (!$userGrid) return;
	if (restoring) {
		setBaseline($userGrid);
		return;
	}
	if (!lastSnapshot) {
		setBaseline($userGrid);
		return;
	}
	if (gridsEqual($userGrid, lastSnapshot)) return;

	undoStack.push(lastSnapshot);
	if (undoStack.length > MAX_HISTORY) undoStack.shift();
	redoStack = [];
	updateLengths();
	setBaseline($userGrid);
});

export function undo() {
	return;
}

export function redo() {
	if (redoStack.length === 0) return;
	const current = cloneGrid(get(userGrid));
	const next = redoStack.pop();
	undoStack.push(current);
	restoring = true;
	userGrid.replace(next);
	restoring = false;
	updateLengths();
}

export function resetHistory() {
	undoStack = [];
	redoStack = [];
	updateLengths();
	setBaseline(get(userGrid));
}
