/**
 * 数独Wiki题目解析器 
 * 负责将SudokuWiki URL转换为9x9数组
 */

/**
 * 解析SudokuWiki URL并返回9x9数独网格
 * @param {string} url - SudokuWiki URL
 * @returns {number[][]|null} 9x9数组，如果不是Wiki URL则返回null
 */
export function parseWikiUrl(url) {
    // 1. 基本验证：是否以http开头且包含bd=
    if (!isWikiUrl(url)) {
        return null;
    }
    
    try {
        // 2. 提取bd=后面的81位数字
        const boardString = extractBoardString(url);
        
        // 3. 转换为9x9二维数组
        return convertToGrid(boardString);
        
    } catch (error) {
        console.warn('解析SudokuWiki URL失败:', error.message);
        return null;
    }
}

/**
 * 判断是否为SudokuWiki URL
 * @param {string} str - 输入的字符串
 * @returns {boolean}
 */
function isWikiUrl(str) {
    if (typeof str !== 'string') return false;
    
    // 简单判断：以http开头且包含bd=
    return str.startsWith('http') && str.includes('bd=');
}

/**
 * 从URL中提取81位棋盘字符串
 * @param {string} url - SudokuWiki URL
 * @returns {string} 81位数字字符串
 * @throws {Error} 如果格式不正确
 */
function extractBoardString(url) {
    // 查找bd=参数
    const bdIndex = url.indexOf('bd=');
    if (bdIndex === -1) {
        throw new Error('未找到bd参数');
    }
    
    // 提取bd=后面的部分
    let boardPart = url.substring(bdIndex + 3);
    
    // 移除可能的后缀（如&其他参数）
    const andIndex = boardPart.indexOf('&');
    if (andIndex !== -1) {
        boardPart = boardPart.substring(0, andIndex);
    }
    
    // 只取前81个字符
    const boardString = boardPart.substring(0, 81);
    
    // 验证长度
    if (boardString.length < 81) {
        throw new Error(`编码长度不足81位，只有${boardString.length}位`);
    }
    
    return boardString;
}

/**
 * 将81位字符串转换为9x9数组
 * @param {string} boardString - 81位数字字符串
 * @returns {number[][]} 9x9数组
 */
function convertToGrid(boardString) {
    const grid = [];
    
    for (let row = 0; row < 9; row++) {
        const rowArray = [];
        for (let col = 0; col < 9; col++) {
            const char = boardString[row * 9 + col];
            // 将点号(.)转换为0，其他非数字字符也转为0
            const num = char === '.' ? 0 : parseInt(char);
            rowArray.push(isNaN(num) ? 0 : num);
        }
        grid.push(rowArray);
    }
    
    return grid;
}
